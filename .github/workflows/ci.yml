# =============================================================================
# .github/workflows/ci.yml
# =============================================================================
# CI workflow for TensorFlowWrap - C++20 Wrapper for TensorFlow C API
#
# Directory structure:
#   Headers:    include/tf_wrap/*.hpp
#   Tests:      tests/test_*.cpp
#   Stub:       third_party/tf_stub/
#
# Requirements:
#   - C++20 (required)
#   - Header-only library (no build step for library itself)
#   - Tests use stub TensorFlow C API (no real TF installation needed)
#
# Jobs:
#   - linux-gcc: GCC 12/13 build + tests
#   - linux-clang: Clang 15/16 build + tests
#   - windows-msvc: MSVC build + tests
#   - macos: Apple Clang on ARM (macos-14)
#   - sanitizer-asan: AddressSanitizer
#   - sanitizer-ubsan: UndefinedBehaviorSanitizer
#   - sanitizer-tsan: ThreadSanitizer
#   - header-check: Verify headers compile standalone
#   - stress-test: Run stress/fuzz tests
#   - strict-warnings: Extra warning flags
#   - real-tensorflow: Comprehensive tests with real TensorFlow C library
#                      (TF 2.14.0, 2.15.0 - includes 30s soak test)
#   - ci-success: Gate job
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

env:
  INCLUDE_DIR: include
  TEST_DIR: tests
  STUB_DIR: third_party/tf_stub

jobs:
  # ===========================================================================
  # Linux GCC
  # ===========================================================================
  linux-gcc:
    name: Linux GCC-${{ matrix.version }} C++${{ matrix.std }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 12
            std: 20
            runner: ubuntu-22.04
          - version: 13
            std: 20
            runner: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-${{ matrix.version }}

      - name: Build and run tests
        run: |
          echo "Building with GCC-${{ matrix.version }} C++${{ matrix.std }}..."
          
          g++-${{ matrix.version }} -std=c++${{ matrix.std }} \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main
          
          echo "Running tests..."
          ./test_main

      - name: Build and run edge case tests
        run: |
          g++-${{ matrix.version }} -std=c++${{ matrix.std }} \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_cases
          
          ./test_edge_cases

  # ===========================================================================
  # Linux Clang
  # ===========================================================================
  linux-clang:
    name: Linux Clang-${{ matrix.version }} C++${{ matrix.std }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 15
            std: 20
          - version: 16
            std: 20

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ matrix.version }}

      - name: Build and run tests
        run: |
          echo "Building with Clang-${{ matrix.version }} C++${{ matrix.std }}..."
          
          clang++-${{ matrix.version }} -std=c++${{ matrix.std }} \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main
          
          echo "Running tests..."
          ./test_main

      - name: Build and run edge case tests
        run: |
          clang++-${{ matrix.version }} -std=c++${{ matrix.std }} \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_cases
          
          ./test_edge_cases

  # ===========================================================================
  # Windows MSVC
  # ===========================================================================
  windows-msvc:
    name: Windows MSVC C++${{ matrix.std }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        std: [20]

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build and run tests
        shell: cmd
        run: |
          echo Building with MSVC C++${{ matrix.std }}...
          
          cl /std:c++${{ matrix.std }} /W4 /WX /EHsc ^
            /I${{ env.INCLUDE_DIR }} ^
            /I${{ env.STUB_DIR }} ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            ${{ env.TEST_DIR }}\test_main.cpp ^
            ${{ env.STUB_DIR }}\tf_c_stub.cpp ^
            /Fe:test_main.exe
          
          echo Running tests...
          test_main.exe

      - name: Build and run edge case tests
        shell: cmd
        run: |
          cl /std:c++${{ matrix.std }} /W4 /WX /EHsc ^
            /I${{ env.INCLUDE_DIR }} ^
            /I${{ env.STUB_DIR }} ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            ${{ env.TEST_DIR }}\test_edge_cases.cpp ^
            ${{ env.STUB_DIR }}\tf_c_stub.cpp ^
            /Fe:test_edge_cases.exe
          
          test_edge_cases.exe

  # ===========================================================================
  # AddressSanitizer
  # ===========================================================================
  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build with ASAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main_asan

      - name: Run with ASAN
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        run: ./test_main_asan

      - name: Build edge cases with ASAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_asan

      - name: Run edge cases with ASAN
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        run: ./test_edge_asan

  # ===========================================================================
  # UndefinedBehaviorSanitizer
  # ===========================================================================
  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build with UBSAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main_ubsan

      - name: Run with UBSAN
        env:
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: ./test_main_ubsan

      - name: Build edge cases with UBSAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_ubsan

      - name: Run edge cases with UBSAN
        env:
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: ./test_edge_ubsan

  # ===========================================================================
  # ThreadSanitizer
  # ===========================================================================
  sanitizer-tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build with TSAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=thread -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main_tsan

      - name: Run with TSAN
        env:
          TSAN_OPTIONS: abort_on_error=1
        run: ./test_main_tsan

      - name: Build edge cases with TSAN
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=thread -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_tsan

      - name: Run edge cases with TSAN
        env:
          TSAN_OPTIONS: abort_on_error=1
        run: ./test_edge_tsan

  # ===========================================================================
  # Header Standalone Compile Check
  # ===========================================================================
  header-check:
    name: Header Standalone Compile
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Check each header compiles standalone
        run: |
          echo "Checking each header compiles standalone..."
          
          success=0
          failed=0
          
          for header in ${{ env.INCLUDE_DIR }}/tf_wrap/*.hpp; do
            basename=$(basename "$header")
            
            # Create test file that includes only this header
            cat > test_header.cpp << EOF
          #include "tf_wrap/$basename"
          int main() { return 0; }
          EOF
            
            if g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
              -I${{ env.INCLUDE_DIR }} \
              -I${{ env.STUB_DIR }} \
              -DTF_WRAPPER_TF_STUB_ENABLED=1 \
              -c test_header.cpp -o /dev/null 2>&1; then
              echo "✓ $basename"
              success=$((success + 1))
            else
              echo "✗ $basename"
              g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
                -I${{ env.INCLUDE_DIR }} \
                -I${{ env.STUB_DIR }} \
                -DTF_WRAPPER_TF_STUB_ENABLED=1 \
                -c test_header.cpp 2>&1 || true
              failed=$((failed + 1))
            fi
          done
          
          rm -f test_header.cpp
          
          echo ""
          echo "Results: $success passed, $failed failed"
          
          if [ $failed -gt 0 ]; then
            echo "❌ Some headers failed standalone compilation"
            exit 1
          fi
          
          echo "✓ All headers compile standalone"

  # ===========================================================================
  # Stress Tests
  # ===========================================================================
  stress-test:
    name: Stress & Fuzz Tests
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build stress tests
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -O2 \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -DNDEBUG \
            -pthread \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_stress

      - name: Run stress tests
        timeout-minutes: 5
        run: ./test_stress --stress

  # ===========================================================================
  # Real TensorFlow Integration Test (Multiple Versions)
  # ===========================================================================
  real-tensorflow:
    name: Real TensorFlow ${{ matrix.tf_version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        tf_version: ["2.14.0", "2.15.0"]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12 curl

      - name: Download TensorFlow C library
        run: |
          echo "Downloading TensorFlow C library v${{ matrix.tf_version }}..."
          TF_URL="https://storage.googleapis.com/tensorflow/libtensorflow/libtensorflow-cpu-linux-x86_64-${{ matrix.tf_version }}.tar.gz"
          
          mkdir -p tensorflow_c
          
          echo "Fetching from: $TF_URL"
          curl -fSL --retry 3 "$TF_URL" -o tf.tar.gz
          
          file tf.tar.gz
          tar -xzf tf.tar.gz -C tensorflow_c
          
          echo "TensorFlow C library contents:"
          ls -la tensorflow_c/lib/

      - name: Build and run comprehensive real TF test suite
        timeout-minutes: 10
        run: |
          echo "Building comprehensive test suite with real TensorFlow..."
          
          TF_INCLUDE="tensorflow_c/include"
          TF_LIB="tensorflow_c/lib"
          
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -I"$TF_INCLUDE" \
            ${{ env.TEST_DIR }}/test_real_tf.cpp \
            -L"$TF_LIB" \
            -ltensorflow \
            -Wl,-rpath,"$TF_LIB" \
            -pthread \
            -o test_real_tf
          
          export LD_LIBRARY_PATH="$(pwd)/tensorflow_c/lib:$LD_LIBRARY_PATH"
          
          echo "Running comprehensive test suite (includes 30-second soak test)..."
          ./test_real_tf
          
          echo "✓ All real TensorFlow tests passed"

      - name: Build and run simple integration test
        run: |
          TF_INCLUDE="tensorflow_c/include"
          TF_LIB="tensorflow_c/lib"
          
          g++-12 -std=c++20 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -I"$TF_INCLUDE" \
            ${{ env.TEST_DIR }}/test_integration.cpp \
            -L"$TF_LIB" \
            -ltensorflow \
            -Wl,-rpath,"$TF_LIB" \
            -o test_integration
          
          export LD_LIBRARY_PATH="$(pwd)/tensorflow_c/lib:$LD_LIBRARY_PATH"
          ./test_integration
          
          echo "✓ Integration test passed"

  # ===========================================================================
  # Strict Warnings
  # ===========================================================================
  strict-warnings:
    name: Strict Warnings
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build with extra warnings
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wconversion -Wsign-conversion -Wshadow \
            -Wnon-virtual-dtor -Wold-style-cast -Wcast-align \
            -Wunused -Woverloaded-virtual -Wformat=2 \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_strict 2>&1 | tee warnings.log
          
          # Count warnings (should be 0 with -Werror, but log anyway)
          if [ -s warnings.log ]; then
            echo "Build output:"
            cat warnings.log
          fi
          
          echo "✓ Built with strict warnings"

      - name: Run strict build
        run: ./test_strict

  # ===========================================================================
  # macOS (Apple Clang)
  # ===========================================================================
  macos:
    name: macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14]  # ARM only (macos-13 deprecated)

    steps:
      - uses: actions/checkout@v4

      - name: Build and run tests
        run: |
          echo "Compiler version:"
          clang++ --version
          
          echo "Building test_main..."
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.TEST_DIR }}/test_main.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_main
          
          echo "Running tests..."
          ./test_main

      - name: Build and run edge case tests
        run: |
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.TEST_DIR }}/test_edge_cases.cpp \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o test_edge_cases
          
          ./test_edge_cases

  # ===========================================================================
  # CI Success Gate
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - linux-gcc
      - linux-clang
      - windows-msvc
      - macos
      - sanitizer-asan
      - sanitizer-ubsan
      - sanitizer-tsan
      - header-check
      - stress-test
      - strict-warnings
      - real-tensorflow
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "Job results:"
          echo "  linux-gcc:        ${{ needs.linux-gcc.result }}"
          echo "  linux-clang:      ${{ needs.linux-clang.result }}"
          echo "  windows-msvc:     ${{ needs.windows-msvc.result }}"
          echo "  macos:            ${{ needs.macos.result }}"
          echo "  sanitizer-asan:   ${{ needs.sanitizer-asan.result }}"
          echo "  sanitizer-ubsan:  ${{ needs.sanitizer-ubsan.result }}"
          echo "  sanitizer-tsan:   ${{ needs.sanitizer-tsan.result }}"
          echo "  header-check:     ${{ needs.header-check.result }}"
          echo "  stress-test:      ${{ needs.stress-test.result }}"
          echo "  strict-warnings:  ${{ needs.strict-warnings.result }}"
          echo "  real-tensorflow:  ${{ needs.real-tensorflow.result }}"
          
          if [ "${{ needs.linux-gcc.result }}" != "success" ] || \
             [ "${{ needs.linux-clang.result }}" != "success" ] || \
             [ "${{ needs.windows-msvc.result }}" != "success" ] || \
             [ "${{ needs.macos.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-asan.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-ubsan.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-tsan.result }}" != "success" ] || \
             [ "${{ needs.header-check.result }}" != "success" ] || \
             [ "${{ needs.stress-test.result }}" != "success" ] || \
             [ "${{ needs.strict-warnings.result }}" != "success" ] || \
             [ "${{ needs.real-tensorflow.result }}" != "success" ]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi
          
          echo "✓ All CI jobs passed"
