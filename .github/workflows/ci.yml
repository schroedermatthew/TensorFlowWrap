name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux-64bit:
    name: Linux 64-bit (GCC)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_tensor.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_tensor
          
          ./test_tensor

  linux-32bit:
    name: Linux 32-bit (GCC)
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install 32-bit toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib
      
      - name: Build and run tests (32-bit)
        run: |
          g++ -std=c++20 -m32 \
            -Wall -Wextra -Wpedantic -Werror \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_safety.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_safety_32
          
          ./test_safety_32

  test-safety:
    name: Safety Invariant Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run safety tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -fsanitize=address,undefined \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_safety.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_safety
          
          ./test_safety

  test-stub-dtype:
    name: Stub Dtype Tracking Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run dtype tracking tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_stub_dtype_tracking.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_stub_dtype
          
          ./test_stub_dtype

  test-easy-helpers:
    name: Easy Helpers Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run helper tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_easy_helpers.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_easy_helpers
          
          ./test_easy_helpers

  test-bool-tensor:
    name: Bool Tensor Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run bool tensor tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -fsanitize=address,undefined \
            -I./include \
            -I./third_party/tf_stub \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_bool_tensor.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_bool_tensor
          
          ./test_bool_tensor

  test-improvements:
    name: All Improvements Tests
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and run all improvement tests
        run: |
          g++-14 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I./include \
            -I./third_party/tf_stub \
            -I./tests \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -pthread \
            tests/test_improvements.cpp \
            third_party/tf_stub/tf_c_stub.cpp \
            -o test_improvements
          
          ./test_improvements
