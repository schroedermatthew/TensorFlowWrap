# =============================================================================
# .github/workflows/ci.yml
# =============================================================================
# CI workflow for TensorFlowWrap - Production Inference C++20 Wrapper
#
# Directory structure:
#   Headers:    include/tf_wrap/*.hpp
#   Tests:      tests/test_*.cpp
#   Stub:       third_party/tf_stub/
#
# Jobs:
#   - header-check: Verify all headers compile standalone
#   - linux-gcc: GCC 13/14 build + tests
#   - linux-clang: Clang 17/18 build + tests
#   - macos: Apple Clang (ARM) build + tests
#   - windows-msvc: MSVC build + tests
#   - sanitizers: ASan + UBSan
#   - real-tensorflow: Real TF library tests (6 versions)
#   - ci-success: Gate job
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

env:
  INCLUDE_DIR: include
  TEST_DIR: tests
  STUB_DIR: third_party/tf_stub

jobs:
  # ===========================================================================
  # Header Standalone Compile Check
  # ===========================================================================
  header-check:
    name: Header Standalone Compile
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Check each header compiles standalone
        run: |
          echo "Checking each header compiles standalone..."
          
          success=0
          failed=0
          
          for header in ${{ env.INCLUDE_DIR }}/tf_wrap/*.hpp; do
            basename=$(basename "$header")
            
            cat > test_header.cpp << EOF
          #include "tf_wrap/$basename"
          int main() { return 0; }
          EOF
            
            if g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
              -I${{ env.INCLUDE_DIR }} \
              -I${{ env.STUB_DIR }} \
              -DTF_WRAPPER_TF_STUB_ENABLED=1 \
              -c test_header.cpp -o /dev/null 2>&1; then
              echo "✓ $basename"
              success=$((success + 1))
            else
              echo "✗ $basename"
              g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
                -I${{ env.INCLUDE_DIR }} \
                -I${{ env.STUB_DIR }} \
                -DTF_WRAPPER_TF_STUB_ENABLED=1 \
                -c test_header.cpp 2>&1 || true
              failed=$((failed + 1))
            fi
          done
          
          rm -f test_header.cpp
          
          echo ""
          echo "Results: $success passed, $failed failed"
          
          if [ $failed -gt 0 ]; then
            echo "❌ Some headers failed standalone compilation"
            exit 1
          fi
          
          echo "✓ All headers compile standalone"

  # ===========================================================================
  # Linux GCC
  # ===========================================================================
  linux-gcc:
    name: Linux GCC-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [13, 14]

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-${{ matrix.version }}

      - name: Build and run SmallVector tests
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector
          ./test_small_vector

      - name: Build and run ScopeGuard tests
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard
          ./test_scope_guard

      - name: Build and run Tensor tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_tensor.cpp \
            -o test_tensor
          ./test_tensor

      - name: Build and run Session tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_session.cpp \
            -o test_session
          ./test_session

      - name: Build and run Facade tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_facade.cpp \
            -o test_facade
          ./test_facade

      - name: Build and run Graph tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_graph.cpp \
            -o test_graph
          ./test_graph

      - name: Build and run Status tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_status.cpp \
            -o test_status
          ./test_status

      - name: Build and run Error tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_error.cpp \
            -o test_error
          ./test_error

      - name: Build and run Format tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_format.cpp \
            -o test_format
          ./test_format

      - name: Build and run Operation tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_operation.cpp \
            -o test_operation
          ./test_operation

      - name: Build and run Lifecycle tests (stub)
        run: |
          g++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_lifecycle.cpp \
            -o test_lifecycle
          ./test_lifecycle

      - name: Run compile-fail tests
        run: |
          chmod +x ${{ env.TEST_DIR }}/run_compile_fail_tests.sh
          ${{ env.TEST_DIR }}/run_compile_fail_tests.sh \
            g++-${{ matrix.version }} \
            ${{ env.INCLUDE_DIR }} \
            ${{ env.STUB_DIR }}

      - name: Build and verify library compilation
        run: |
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              tf_wrap::SmallVector<int, 4> sv;
              sv.push_back(1);
              return 0;
          }
          EOF
          
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          ./compile_test
          echo "✓ GCC-${{ matrix.version }} build successful"

  # ===========================================================================
  # Linux Clang
  # ===========================================================================
  linux-clang:
    name: Linux Clang-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [17, 18]

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ matrix.version }}

      - name: Build and run SmallVector tests
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector
          ./test_small_vector

      - name: Build and run ScopeGuard tests
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard
          ./test_scope_guard

      - name: Build and run Tensor tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_tensor.cpp \
            -o test_tensor
          ./test_tensor

      - name: Build and run Session tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_session.cpp \
            -o test_session
          ./test_session

      - name: Build and run Facade tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_facade.cpp \
            -o test_facade
          ./test_facade

      - name: Build and run Graph tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_graph.cpp \
            -o test_graph
          ./test_graph

      - name: Build and run Status tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_status.cpp \
            -o test_status
          ./test_status

      - name: Build and run Error tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_error.cpp \
            -o test_error
          ./test_error

      - name: Build and run Format tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_format.cpp \
            -o test_format
          ./test_format

      - name: Build and run Operation tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_operation.cpp \
            -o test_operation
          ./test_operation

      - name: Build and run Lifecycle tests (stub)
        run: |
          clang++-${{ matrix.version }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_lifecycle.cpp \
            -o test_lifecycle
          ./test_lifecycle

      - name: Run compile-fail tests
        run: |
          chmod +x ${{ env.TEST_DIR }}/run_compile_fail_tests.sh
          ${{ env.TEST_DIR }}/run_compile_fail_tests.sh \
            clang++-${{ matrix.version }} \
            ${{ env.INCLUDE_DIR }} \
            ${{ env.STUB_DIR }}

      - name: Build and verify library compilation
        run: |
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              return 0;
          }
          EOF
          
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          ./compile_test
          echo "✓ Clang-${{ matrix.version }} build successful"

  # ===========================================================================
  # Windows MSVC
  # ===========================================================================
  windows-msvc:
    name: Windows MSVC
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build and run SmallVector tests
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_small_vector.cpp ^
            /Fe:test_small_vector.exe
          test_small_vector.exe

      - name: Build and run ScopeGuard tests
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_scope_guard.cpp ^
            /Fe:test_scope_guard.exe
          test_scope_guard.exe

      - name: Build and run Tensor tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_tensor.cpp ^
            /Fe:test_tensor.exe
          test_tensor.exe

      - name: Build and run Session tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_session.cpp ^
            /Fe:test_session.exe
          test_session.exe

      - name: Build and run Facade tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_facade.cpp ^
            /Fe:test_facade.exe
          test_facade.exe

      - name: Build and run Graph tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_graph.cpp ^
            /Fe:test_graph.exe
          test_graph.exe

      - name: Build and run Status tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_status.cpp ^
            /Fe:test_status.exe
          test_status.exe

      - name: Build and run Error tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_error.cpp ^
            /Fe:test_error.exe
          test_error.exe

      - name: Build and run Format tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_format.cpp ^
            /Fe:test_format.exe
          test_format.exe

      - name: Build and run Operation tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_operation.cpp ^
            /Fe:test_operation.exe
          test_operation.exe

      - name: Build and run Lifecycle tests (stub)
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            %STUB_DIR%\tf_c_stub.cpp ^
            %TEST_DIR%\test_lifecycle.cpp ^
            /Fe:test_lifecycle.exe
          test_lifecycle.exe

      - name: Build and verify library compilation
        shell: cmd
        run: |
          cl /std:c++20 /W4 /WX /EHsc ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            /c %STUB_DIR%\tf_c_stub.cpp ^
            /Fo:stub.obj
          
          echo #include "tf_wrap/core.hpp" > compile_test.cpp
          echo int main() { >> compile_test.cpp
          echo     tf_wrap::SessionOptions opts; >> compile_test.cpp
          echo     (void)opts; >> compile_test.cpp
          echo     auto t = tf_wrap::Tensor::FromScalar^<float^>(1.0f); >> compile_test.cpp
          echo     (void)t.dtype(); >> compile_test.cpp
          echo     return 0; >> compile_test.cpp
          echo } >> compile_test.cpp
          
          cl /std:c++20 /W4 /WX /EHsc ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            compile_test.cpp stub.obj ^
            /Fe:compile_test.exe
          compile_test.exe
          echo MSVC build successful

  # ===========================================================================
  # macOS (Apple Clang)
  # ===========================================================================
  macos:
    name: macOS (Apple Clang)
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Build and run SmallVector tests
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector
          ./test_small_vector

      - name: Build and run ScopeGuard tests
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard
          ./test_scope_guard

      - name: Build and run Tensor tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_tensor.cpp \
            -o test_tensor
          ./test_tensor

      - name: Build and run Session tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_session.cpp \
            -o test_session
          ./test_session

      - name: Build and run Facade tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_facade.cpp \
            -o test_facade
          ./test_facade

      - name: Build and run Graph tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_graph.cpp \
            -o test_graph
          ./test_graph

      - name: Build and run Status tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_status.cpp \
            -o test_status
          ./test_status

      - name: Build and run Error tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_error.cpp \
            -o test_error
          ./test_error

      - name: Build and run Format tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_format.cpp \
            -o test_format
          ./test_format

      - name: Build and run Operation tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_operation.cpp \
            -o test_operation
          ./test_operation

      - name: Build and run Lifecycle tests (stub)
        run: |
          clang++ -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_lifecycle.cpp \
            -o test_lifecycle
          ./test_lifecycle

      - name: Run compile-fail tests
        run: |
          chmod +x ${{ env.TEST_DIR }}/run_compile_fail_tests.sh
          ${{ env.TEST_DIR }}/run_compile_fail_tests.sh \
            clang++ \
            ${{ env.INCLUDE_DIR }} \
            ${{ env.STUB_DIR }}

      - name: Build and verify library compilation
        run: |
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              return 0;
          }
          EOF
          
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          ./compile_test
          echo "✓ macOS build successful"

  # ===========================================================================
  # Sanitizers
  # ===========================================================================
  sanitizers:
    name: Sanitizers (ASan + UBSan)
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build and run with AddressSanitizer
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        run: |
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_asan
          ./test_asan
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_asan_sv
          ./test_asan_sv
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_tensor.cpp \
            -o test_asan_tensor
          ./test_asan_tensor
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_session.cpp \
            -o test_asan_session
          ./test_asan_session
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_facade.cpp \
            -o test_asan_facade
          ./test_asan_facade
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_graph.cpp \
            -o test_asan_graph
          ./test_asan_graph
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_status.cpp \
            -o test_asan_status
          ./test_asan_status
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_error.cpp \
            -o test_asan_error
          ./test_asan_error
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_format.cpp \
            -o test_asan_format
          ./test_asan_format
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_operation.cpp \
            -o test_asan_operation
          ./test_asan_operation
          
          g++-13 -std=c++20 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_lifecycle.cpp \
            -o test_asan_lifecycle
          ./test_asan_lifecycle
          echo "✓ ASan passed"

      - name: Build and run with UndefinedBehaviorSanitizer
        env:
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: |
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_ubsan
          ./test_ubsan
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_ubsan_sv
          ./test_ubsan_sv
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_tensor.cpp \
            -o test_ubsan_tensor
          ./test_ubsan_tensor
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_session.cpp \
            -o test_ubsan_session
          ./test_ubsan_session
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_facade.cpp \
            -o test_ubsan_facade
          ./test_ubsan_facade
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_graph.cpp \
            -o test_ubsan_graph
          ./test_ubsan_graph
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_status.cpp \
            -o test_ubsan_status
          ./test_ubsan_status
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_error.cpp \
            -o test_ubsan_error
          ./test_ubsan_error
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_format.cpp \
            -o test_ubsan_format
          ./test_ubsan_format
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_operation.cpp \
            -o test_ubsan_operation
          ./test_ubsan_operation
          
          g++-13 -std=c++20 -g \
            -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/test_lifecycle.cpp \
            -o test_ubsan_lifecycle
          ./test_ubsan_lifecycle
          echo "✓ UBSan passed"

  # ===========================================================================
  # Real TensorFlow Integration Test (Multiple Versions)
  # ===========================================================================
  real-tensorflow:
    name: Real TensorFlow ${{ matrix.tf_version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        tf_version: ["2.13.0", "2.14.0", "2.15.0", "2.16.1", "2.17.1", "2.18.1"]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12 curl

      - name: Download TensorFlow C library
        run: |
          TF_VERSION="${{ matrix.tf_version }}"
          TF_MAJOR_MINOR=$(echo "$TF_VERSION" | cut -d. -f1,2)
          
          if [[ "$TF_MAJOR_MINOR" == "2.16" ]] || [[ "$TF_MAJOR_MINOR" == "2.17" ]] || [[ "$TF_MAJOR_MINOR" == "2.18" ]]; then
            TF_URL="https://storage.googleapis.com/tensorflow/versions/${TF_VERSION}/libtensorflow-cpu-linux-x86_64.tar.gz"
          else
            TF_URL="https://storage.googleapis.com/tensorflow/libtensorflow/libtensorflow-cpu-linux-x86_64-${TF_VERSION}.tar.gz"
          fi
          
          mkdir -p tensorflow_c
          curl -fSL --retry 3 "$TF_URL" -o tf.tar.gz
          tar -xzf tf.tar.gz -C tensorflow_c

      - name: Create test SavedModel
        run: |
          TF_VERSION="${{ matrix.tf_version }}"
          TF_MAJOR_MINOR=$(echo "$TF_VERSION" | cut -d. -f1,2)
          
          if [[ "$TF_MAJOR_MINOR" == "2.16" ]] || [[ "$TF_MAJOR_MINOR" == "2.17" ]] || [[ "$TF_MAJOR_MINOR" == "2.18" ]]; then
            pip install tensorflow==${{ matrix.tf_version }} --quiet
          else
            pip install "numpy<2" tensorflow==${{ matrix.tf_version }} --quiet
          fi
          
          python3 << 'PYEOF'
          import tensorflow as tf
          class SimpleModel(tf.Module):
              @tf.function(input_signature=[tf.TensorSpec(shape=[None], dtype=tf.float32)], autograph=False)
              def serve(self, x):
                  return x * 2.0 + 1.0
          model = SimpleModel()
          tf.saved_model.save(model, "test_savedmodel", signatures={"serving_default": model.serve})
          PYEOF

      - name: Build and run tests
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tensorflow_c/lib:$LD_LIBRARY_PATH"
          
          # Tensor tests with real TF
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_tensor_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_tensor_tf
          
          ./test_tensor_tf
          
          # Session tests with real TF
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_session_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_session_tf
          
          ./test_session_tf
          
          # Facade tests with real TF
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_facade_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_facade_tf
          
          ./test_facade_tf
          
          # Graph tests with real TF
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_graph_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_graph_tf
          
          ./test_graph_tf
          
          # Operation tests with real TF
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_operation_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_operation_tf
          
          ./test_operation_tf
          
          # SavedModel inference tests
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -Itensorflow_c/include \
            ${{ env.TEST_DIR }}/test_real_tf_minimal.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_real_tf
          
          ./test_real_tf

  # ===========================================================================
  # Soak Tests (ASan + Real TF)
  # ===========================================================================
  soak-tests:
    name: Soak Tests (ASan + Real TF)
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12 curl

      - name: Download TensorFlow C library
        run: |
          TF_URL="https://storage.googleapis.com/tensorflow/versions/2.18.1/libtensorflow-cpu-linux-x86_64.tar.gz"
          mkdir -p tensorflow_c
          curl -fSL --retry 3 "$TF_URL" -o tf.tar.gz
          tar -xzf tf.tar.gz -C tensorflow_c

      - name: Create test SavedModel
        run: |
          pip install tensorflow==2.18.1 --quiet
          
          python3 << 'PYEOF'
          import tensorflow as tf
          class SimpleModel(tf.Module):
              @tf.function(input_signature=[tf.TensorSpec(shape=[None], dtype=tf.float32)], autograph=False)
              def serve(self, x):
                  return x * 2.0 + 1.0
          model = SimpleModel()
          tf.saved_model.save(model, "test_savedmodel", signatures={"serving_default": model.serve})
          PYEOF

      - name: Build and run soak tests with ASan
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1:print_stats=1:check_initialization_order=1
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tensorflow_c/lib:$LD_LIBRARY_PATH"
          
          echo "Building soak tests with AddressSanitizer..."
          g++-12 -std=c++20 -O1 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -Wall -Wextra -Wpedantic \
            -Iinclude \
            -Itensorflow_c/include \
            tests/test_soak_tf.cpp \
            -Ltensorflow_c/lib \
            -ltensorflow \
            -Wl,-rpath,tensorflow_c/lib \
            -pthread \
            -o test_soak_tf
          
          echo ""
          echo "Running soak tests (this may take several minutes)..."
          echo "ASan will detect memory leaks at process exit."
          echo ""
          
          ./test_soak_tf
          
          echo ""
          echo "✓ Soak tests passed - no memory leaks detected"

  # ===========================================================================
  # Fuzz Tests (libFuzzer)
  # ===========================================================================
  fuzz-tests:
    name: Fuzz Tests
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-15

      - name: Build and run fuzz tests
        run: |
          # Build fuzz_tensor
          clang++-15 -std=c++20 -g -O1 \
            -fsanitize=fuzzer,address,undefined \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/fuzz/fuzz_tensor.cpp \
            -o fuzz_tensor
          
          # Build fuzz_small_vector
          clang++-15 -std=c++20 -g -O1 \
            -fsanitize=fuzzer,address,undefined \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/fuzz/fuzz_small_vector.cpp \
            -o fuzz_small_vector
          
          # Build fuzz_session
          clang++-15 -std=c++20 -g -O1 \
            -fsanitize=fuzzer,address,undefined \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            ${{ env.TEST_DIR }}/fuzz/fuzz_session.cpp \
            -o fuzz_session
          
          echo "✓ All fuzz targets built"
          
          # Create corpus directories
          mkdir -p corpus/tensor corpus/small_vector corpus/session
          
          # Run each fuzzer with limited iterations for CI
          echo "Running fuzz_tensor..."
          ./fuzz_tensor corpus/tensor/ -max_total_time=30 -max_len=1024
          
          echo "Running fuzz_small_vector..."
          ./fuzz_small_vector corpus/small_vector/ -max_total_time=30 -max_len=4096
          
          echo "Running fuzz_session..."
          ./fuzz_session corpus/session/ -max_total_time=30 -max_len=1024
          
          echo "✓ All fuzz tests passed"

  # ===========================================================================
  # CI Success Gate
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - header-check
      - linux-gcc
      - linux-clang
      - windows-msvc
      - macos
      - sanitizers
      - soak-tests
      - real-tensorflow
      - fuzz-tests
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "Job results:"
          echo "  header-check:     ${{ needs.header-check.result }}"
          echo "  linux-gcc:        ${{ needs.linux-gcc.result }}"
          echo "  linux-clang:      ${{ needs.linux-clang.result }}"
          echo "  windows-msvc:     ${{ needs.windows-msvc.result }}"
          echo "  macos:            ${{ needs.macos.result }}"
          echo "  sanitizers:       ${{ needs.sanitizers.result }}"
          echo "  soak-tests:       ${{ needs.soak-tests.result }}"
          echo "  real-tensorflow:  ${{ needs.real-tensorflow.result }}"
          echo "  fuzz-tests:       ${{ needs.fuzz-tests.result }}"
          
          if [ "${{ needs.header-check.result }}" != "success" ] || \
             [ "${{ needs.linux-gcc.result }}" != "success" ] || \
             [ "${{ needs.linux-clang.result }}" != "success" ] || \
             [ "${{ needs.windows-msvc.result }}" != "success" ] || \
             [ "${{ needs.macos.result }}" != "success" ] || \
             [ "${{ needs.sanitizers.result }}" != "success" ] || \
             [ "${{ needs.soak-tests.result }}" != "success" ] || \
             [ "${{ needs.real-tensorflow.result }}" != "success" ] || \
             [ "${{ needs.fuzz-tests.result }}" != "success" ]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi
          
          echo "✓ All CI jobs passed"
