# =============================================================================
# .github/workflows/ci.yml
# =============================================================================
# CI workflow for TensorFlowWrap - Production Inference C++20 Wrapper
#
# This is a header-only library for TensorFlow inference. Tests use a stub
# TensorFlow C API (no real TF installation needed for CI).
#
# Jobs:
#   - header-check: Verify all headers compile standalone
#   - utility-tests: ScopeGuard and SmallVector unit tests
#   - linux-gcc: GCC 12/13/14
#   - linux-clang: Clang 16/17/18
#   - macos: Apple Clang (ARM)
#   - windows: MSVC
#   - sanitizers: ASan, UBSan, TSan
#   - ci-success: Gate job
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  INCLUDE_DIR: include
  TEST_DIR: tests
  STUB_DIR: third_party/tf_stub

jobs:
  # ===========================================================================
  # Header Check - Verify each header compiles standalone
  # ===========================================================================
  header-check:
    name: Header Check
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Check all headers compile standalone
        run: |
          echo "Checking headers compile standalone..."
          
          for header in ${{ env.INCLUDE_DIR }}/tf_wrap/*.hpp; do
            echo "  Checking $header..."
            g++ -std=c++20 -fsyntax-only \
              -I${{ env.INCLUDE_DIR }} \
              -I${{ env.STUB_DIR }} \
              "$header"
          done
          
          echo "✓ All headers compile standalone"

  # ===========================================================================
  # Utility Tests - ScopeGuard and SmallVector (no TF dependency)
  # ===========================================================================
  utility-tests:
    name: Utility Tests (${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            compiler: g++-13
            install: g++-13
          - os: ubuntu-24.04
            compiler: clang++-17
            install: clang-17
          - os: macos-14
            compiler: clang++
            install: ""

    steps:
      - uses: actions/checkout@v4

      - name: Install compiler
        if: matrix.install != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.install }}

      - name: Build and run ScopeGuard tests
        run: |
          ${{ matrix.compiler }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard
          
          ./test_scope_guard

      - name: Build and run SmallVector tests
        run: |
          ${{ matrix.compiler }} -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector
          
          ./test_small_vector

  # ===========================================================================
  # Utility Tests - Windows MSVC
  # ===========================================================================
  utility-tests-windows:
    name: Utility Tests (MSVC)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build and run ScopeGuard tests
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cl /std:c++20 /EHsc /W4 /WX ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_scope_guard.cpp ^
            /Fe:test_scope_guard.exe
          test_scope_guard.exe

      - name: Build and run SmallVector tests
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cl /std:c++20 /EHsc /W4 /WX ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_small_vector.cpp ^
            /Fe:test_small_vector.exe
          test_small_vector.exe

  # ===========================================================================
  # Linux GCC
  # ===========================================================================
  linux-gcc:
    name: Linux GCC-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [13, 14]

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-${{ matrix.version }}

      - name: Build stub and verify compilation
        run: |
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          # Compile a simple test that exercises the main APIs
          cat > /tmp/compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              // Verify types exist and compile
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              return 0;
          }
          EOF
          
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            /tmp/compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ GCC-${{ matrix.version }} compilation successful"

  # ===========================================================================
  # Linux Clang
  # ===========================================================================
  linux-clang:
    name: Linux Clang-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [17, 18]

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ matrix.version }}

      - name: Build stub and verify compilation
        run: |
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > /tmp/compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              return 0;
          }
          EOF
          
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            /tmp/compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ Clang-${{ matrix.version }} compilation successful"

  # ===========================================================================
  # macOS (Apple Clang)
  # ===========================================================================
  macos:
    name: macOS (Apple Clang)
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Build stub and verify compilation
        run: |
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > /tmp/compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              return 0;
          }
          EOF
          
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            /tmp/compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ macOS compilation successful"

  # ===========================================================================
  # Windows MSVC
  # ===========================================================================
  windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build and verify compilation
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          cl /std:c++20 /EHsc /W4 /WX ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            /c %STUB_DIR%\tf_c_stub.cpp ^
            /Fo:stub.obj
          
          echo #include "tf_wrap/core.hpp" > compile_test.cpp
          echo int main() { >> compile_test.cpp
          echo     tf_wrap::SessionOptions opts; >> compile_test.cpp
          echo     (void)opts; >> compile_test.cpp
          echo     auto t = tf_wrap::Tensor::FromScalar^<float^>(1.0f); >> compile_test.cpp
          echo     (void)t.dtype(); >> compile_test.cpp
          echo     return 0; >> compile_test.cpp
          echo } >> compile_test.cpp
          
          cl /std:c++20 /EHsc /W4 /WX ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            compile_test.cpp stub.obj ^
            /Fe:compile_test.exe
          
          compile_test.exe
          echo ✓ Windows MSVC compilation successful

  # ===========================================================================
  # Sanitizers
  # ===========================================================================
  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Build and run with ASan
        run: |
          g++ -std=c++20 -O1 -g \
            -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_asan
          
          ASAN_OPTIONS=detect_leaks=1 ./test_asan
          echo "✓ ASan passed"

  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Build and run with UBSan
        run: |
          g++ -std=c++20 -O1 -g \
            -fsanitize=undefined \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_ubsan
          
          ./test_ubsan
          
          g++ -std=c++20 -O1 -g \
            -fsanitize=undefined \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_ubsan_sv
          
          ./test_ubsan_sv
          echo "✓ UBSan passed"

  # ===========================================================================
  # CI Success Gate
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - header-check
      - utility-tests
      - utility-tests-windows
      - linux-gcc
      - linux-clang
      - macos
      - windows
      - sanitizer-asan
      - sanitizer-ubsan
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "Job results:"
          echo "  header-check:           ${{ needs.header-check.result }}"
          echo "  utility-tests:          ${{ needs.utility-tests.result }}"
          echo "  utility-tests-windows:  ${{ needs.utility-tests-windows.result }}"
          echo "  linux-gcc:              ${{ needs.linux-gcc.result }}"
          echo "  linux-clang:            ${{ needs.linux-clang.result }}"
          echo "  macos:                  ${{ needs.macos.result }}"
          echo "  windows:                ${{ needs.windows.result }}"
          echo "  sanitizer-asan:         ${{ needs.sanitizer-asan.result }}"
          echo "  sanitizer-ubsan:        ${{ needs.sanitizer-ubsan.result }}"
          
          if [ "${{ needs.header-check.result }}" != "success" ] || \
             [ "${{ needs.utility-tests.result }}" != "success" ] || \
             [ "${{ needs.utility-tests-windows.result }}" != "success" ] || \
             [ "${{ needs.linux-gcc.result }}" != "success" ] || \
             [ "${{ needs.linux-clang.result }}" != "success" ] || \
             [ "${{ needs.macos.result }}" != "success" ] || \
             [ "${{ needs.windows.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-asan.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-ubsan.result }}" != "success" ]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi
          
          echo "✓ All CI jobs passed"
