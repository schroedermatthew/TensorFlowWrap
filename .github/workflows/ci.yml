# =============================================================================
# .github/workflows/ci.yml
# =============================================================================
# CI workflow for TensorFlowWrap - Production Inference C++20 Wrapper
#
# Directory structure:
#   Headers:    include/tf_wrap/*.hpp
#   Tests:      tests/test_*.cpp
#   Stub:       third_party/tf_stub/
#
# Jobs:
#   - header-check: Verify all headers compile standalone
#   - utility-tests: ScopeGuard and SmallVector unit tests
#   - utility-tests-windows: Same for MSVC
#   - linux-gcc: GCC 13 build verification
#   - linux-clang: Clang 17 build verification
#   - macos: Apple Clang (ARM)
#   - windows-msvc: MSVC build verification
#   - sanitizer-asan: AddressSanitizer
#   - sanitizer-ubsan: UndefinedBehaviorSanitizer
#   - ci-success: Gate job
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'include/**'
      - 'tests/**'
      - 'third_party/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

env:
  INCLUDE_DIR: include
  TEST_DIR: tests
  STUB_DIR: third_party/tf_stub

jobs:
  # ===========================================================================
  # Header Standalone Compile Check
  # ===========================================================================
  header-check:
    name: Header Standalone Compile
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Check each header compiles standalone
        run: |
          echo "Checking each header compiles standalone..."
          
          success=0
          failed=0
          
          for header in ${{ env.INCLUDE_DIR }}/tf_wrap/*.hpp; do
            basename=$(basename "$header")
            
            # Create test file that includes only this header
            cat > test_header.cpp << EOF
          #include "tf_wrap/$basename"
          int main() { return 0; }
          EOF
            
            if g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
              -I${{ env.INCLUDE_DIR }} \
              -I${{ env.STUB_DIR }} \
              -DTF_WRAPPER_TF_STUB_ENABLED=1 \
              -c test_header.cpp -o /dev/null 2>&1; then
              echo "✓ $basename"
              success=$((success + 1))
            else
              echo "✗ $basename"
              g++-13 -std=c++20 -Wall -Wextra -Wpedantic -Werror \
                -I${{ env.INCLUDE_DIR }} \
                -I${{ env.STUB_DIR }} \
                -DTF_WRAPPER_TF_STUB_ENABLED=1 \
                -c test_header.cpp 2>&1 || true
              failed=$((failed + 1))
            fi
          done
          
          rm -f test_header.cpp
          
          echo ""
          echo "Results: $success passed, $failed failed"
          
          if [ $failed -gt 0 ]; then
            echo "❌ Some headers failed standalone compilation"
            exit 1
          fi
          
          echo "✓ All headers compile standalone"

  # ===========================================================================
  # Linux GCC
  # ===========================================================================
  linux-gcc:
    name: Linux GCC-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [13, 14]

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-${{ matrix.version }}

      - name: Build and verify compilation
        run: |
          echo "Building with GCC-${{ matrix.version }}..."
          
          # Compile stub
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          # Compile a test that exercises the main APIs
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              // Verify core types compile
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              // Verify SmallVector
              tf_wrap::SmallVector<int, 4> sv;
              sv.push_back(1);
              
              return 0;
          }
          EOF
          
          g++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ GCC-${{ matrix.version }} compilation successful"

  # ===========================================================================
  # Linux Clang
  # ===========================================================================
  linux-clang:
    name: Linux Clang-${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        version: [17, 18]

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ matrix.version }}

      - name: Build and verify compilation
        run: |
          echo "Building with Clang-${{ matrix.version }}..."
          
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              return 0;
          }
          EOF
          
          clang++-${{ matrix.version }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -Wno-gnu-zero-variadic-macro-arguments \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ Clang-${{ matrix.version }} compilation successful"

  # ===========================================================================
  # Windows MSVC
  # ===========================================================================
  windows-msvc:
    name: Windows MSVC
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build and verify compilation
        shell: cmd
        run: |
          echo Building with MSVC...
          
          cl /std:c++20 /W4 /WX /EHsc ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            /c %STUB_DIR%\tf_c_stub.cpp ^
            /Fo:stub.obj
          
          echo #include "tf_wrap/core.hpp" > compile_test.cpp
          echo int main() { >> compile_test.cpp
          echo     tf_wrap::SessionOptions opts; >> compile_test.cpp
          echo     (void)opts; >> compile_test.cpp
          echo     auto t = tf_wrap::Tensor::FromScalar^<float^>(1.0f); >> compile_test.cpp
          echo     (void)t.dtype(); >> compile_test.cpp
          echo     return 0; >> compile_test.cpp
          echo } >> compile_test.cpp
          
          cl /std:c++20 /W4 /WX /EHsc ^
            /I%INCLUDE_DIR% ^
            /I%STUB_DIR% ^
            /DTF_WRAPPER_TF_STUB_ENABLED=1 ^
            compile_test.cpp stub.obj ^
            /Fe:compile_test.exe
          
          compile_test.exe
          echo MSVC compilation successful

  # ===========================================================================
  # macOS (Apple Clang)
  # ===========================================================================
  macos:
    name: macOS (Apple Clang)
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Build and verify compilation
        run: |
          echo "Compiler version:"
          clang++ --version
          
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            -c ${{ env.STUB_DIR }}/tf_c_stub.cpp \
            -o stub.o
          
          cat > compile_test.cpp << 'EOF'
          #include "tf_wrap/core.hpp"
          
          int main() {
              tf_wrap::SessionOptions opts;
              (void)opts;
              
              tf_wrap::Tensor t = tf_wrap::Tensor::FromScalar<float>(1.0f);
              (void)t.dtype();
              (void)t.shape();
              (void)t.num_elements();
              
              return 0;
          }
          EOF
          
          clang++ -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -I${{ env.INCLUDE_DIR }} \
            -I${{ env.STUB_DIR }} \
            -DTF_WRAPPER_TF_STUB_ENABLED=1 \
            compile_test.cpp stub.o \
            -o compile_test
          
          ./compile_test
          echo "✓ macOS compilation successful"

  # ===========================================================================
  # Utility Headers Tests (SmallVector, ScopeGuard)
  # ===========================================================================
  utility-tests:
    name: Utility Headers (${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            compiler: g++-13
            install: sudo apt-get update && sudo apt-get install -y g++-13
          - os: ubuntu-24.04
            compiler: clang++-17
            install: |
              wget https://apt.llvm.org/llvm.sh
              chmod +x llvm.sh
              sudo ./llvm.sh 17
          - os: macos-14
            compiler: clang++
            install: ""

    steps:
      - uses: actions/checkout@v4

      - name: Install compiler
        if: matrix.install != ''
        run: ${{ matrix.install }}

      - name: Build and run SmallVector tests
        run: |
          echo "Building SmallVector tests with ${{ matrix.compiler }}..."
          
          ${{ matrix.compiler }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -O2 \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector
          
          echo "Running SmallVector tests..."
          ./test_small_vector

      - name: Build and run ScopeGuard tests
        run: |
          echo "Building ScopeGuard tests with ${{ matrix.compiler }}..."
          
          ${{ matrix.compiler }} -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -O2 \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard
          
          echo "Running ScopeGuard tests..."
          ./test_scope_guard

  # ===========================================================================
  # Utility Headers - Windows MSVC
  # ===========================================================================
  utility-tests-windows:
    name: Utility Headers (MSVC)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build and run SmallVector tests
        shell: cmd
        run: |
          echo Building SmallVector tests with MSVC...
          
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_small_vector.cpp ^
            /Fe:test_small_vector.exe
          
          echo Running SmallVector tests...
          test_small_vector.exe

      - name: Build and run ScopeGuard tests
        shell: cmd
        run: |
          echo Building ScopeGuard tests with MSVC...
          
          cl /std:c++20 /W4 /WX /EHsc /O2 ^
            /I%INCLUDE_DIR% ^
            %TEST_DIR%\test_scope_guard.cpp ^
            /Fe:test_scope_guard.exe
          
          echo Running ScopeGuard tests...
          test_scope_guard.exe

  # ===========================================================================
  # AddressSanitizer
  # ===========================================================================
  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build and run ScopeGuard with ASan
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard_asan

      - name: Run ScopeGuard with ASan
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        run: ./test_scope_guard_asan

      - name: Build and run SmallVector with ASan
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=address -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector_asan

      - name: Run SmallVector with ASan
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        run: ./test_small_vector_asan

  # ===========================================================================
  # UndefinedBehaviorSanitizer
  # ===========================================================================
  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-13

      - name: Build and run ScopeGuard with UBSan
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_scope_guard.cpp \
            -o test_scope_guard_ubsan

      - name: Run ScopeGuard with UBSan
        env:
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: ./test_scope_guard_ubsan

      - name: Build and run SmallVector with UBSan
        run: |
          g++-13 -std=c++20 \
            -Wall -Wextra -Wpedantic -Werror \
            -g -fsanitize=undefined -fno-omit-frame-pointer \
            -I${{ env.INCLUDE_DIR }} \
            ${{ env.TEST_DIR }}/test_small_vector.cpp \
            -o test_small_vector_ubsan

      - name: Run SmallVector with UBSan
        env:
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: ./test_small_vector_ubsan

  # ===========================================================================
  # Real TensorFlow Integration Test (Multiple Versions)
  # ===========================================================================
  real-tensorflow:
    name: Real TensorFlow ${{ matrix.tf_version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        tf_version: ["2.13.0", "2.14.0", "2.15.0", "2.16.1", "2.17.1", "2.18.1"]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12 curl

      - name: Download TensorFlow C library
        run: |
          echo "Downloading TensorFlow C library v${{ matrix.tf_version }}..."
          
          TF_VERSION="${{ matrix.tf_version }}"
          TF_MAJOR_MINOR=$(echo "$TF_VERSION" | cut -d. -f1,2)
          
          if [[ "$TF_MAJOR_MINOR" == "2.16" ]] || [[ "$TF_MAJOR_MINOR" == "2.17" ]] || [[ "$TF_MAJOR_MINOR" == "2.18" ]]; then
            TF_URL="https://storage.googleapis.com/tensorflow/versions/${TF_VERSION}/libtensorflow-cpu-linux-x86_64.tar.gz"
          else
            TF_URL="https://storage.googleapis.com/tensorflow/libtensorflow/libtensorflow-cpu-linux-x86_64-${TF_VERSION}.tar.gz"
          fi
          
          mkdir -p tensorflow_c
          
          echo "Fetching from: $TF_URL"
          curl -fSL --retry 3 "$TF_URL" -o tf.tar.gz
          tar -xzf tf.tar.gz -C tensorflow_c
          
          echo "TensorFlow C library contents:"
          ls -la tensorflow_c/lib/

      - name: Create test SavedModel with Python
        run: |
          echo "Installing TensorFlow Python..."
          
          TF_VERSION="${{ matrix.tf_version }}"
          TF_MAJOR_MINOR=$(echo "$TF_VERSION" | cut -d. -f1,2)
          
          if [[ "$TF_MAJOR_MINOR" == "2.16" ]] || [[ "$TF_MAJOR_MINOR" == "2.17" ]] || [[ "$TF_MAJOR_MINOR" == "2.18" ]]; then
            pip install tensorflow==${{ matrix.tf_version }} --quiet
          else
            pip install "numpy<2" tensorflow==${{ matrix.tf_version }} --quiet
          fi
          
          echo "Creating test SavedModel..."
          python3 << 'PYEOF'
          import tensorflow as tf
          import os

          class SimpleModel(tf.Module):
              @tf.function(input_signature=[tf.TensorSpec(shape=[None], dtype=tf.float32)], autograph=False)
              def serve(self, x):
                  return x * 2.0 + 1.0

          model = SimpleModel()
          
          result = model.serve(tf.constant([1.0, 2.0, 3.0]))
          print(f"Test run: [1,2,3] -> {result.numpy()}")
          
          export_dir = "test_savedmodel"
          tf.saved_model.save(model, export_dir, signatures={"serving_default": model.serve})
          
          print(f"SavedModel saved to {export_dir}")
          PYEOF
          
          echo "✓ Test SavedModel created"

      - name: Build and run real TF test
        run: |
          TF_INCLUDE="tensorflow_c/include"
          TF_LIB="tensorflow_c/lib"
          
          g++-12 -std=c++20 -O2 \
            -Wall -Wextra -Wpedantic \
            -I${{ env.INCLUDE_DIR }} \
            -I"$TF_INCLUDE" \
            ${{ env.TEST_DIR }}/test_real_tf_minimal.cpp \
            -L"$TF_LIB" \
            -ltensorflow \
            -Wl,-rpath,"$TF_LIB" \
            -pthread \
            -o test_real_tf
          
          export LD_LIBRARY_PATH="$(pwd)/tensorflow_c/lib:$LD_LIBRARY_PATH"
          ./test_real_tf
          
          echo "✓ Real TensorFlow test passed"

  # ===========================================================================
  # CI Success Gate
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - header-check
      - linux-gcc
      - linux-clang
      - windows-msvc
      - macos
      - utility-tests
      - utility-tests-windows
      - sanitizer-asan
      - sanitizer-ubsan
      - real-tensorflow
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "Job results:"
          echo "  header-check:           ${{ needs.header-check.result }}"
          echo "  linux-gcc:              ${{ needs.linux-gcc.result }}"
          echo "  linux-clang:            ${{ needs.linux-clang.result }}"
          echo "  windows-msvc:           ${{ needs.windows-msvc.result }}"
          echo "  macos:                  ${{ needs.macos.result }}"
          echo "  utility-tests:          ${{ needs.utility-tests.result }}"
          echo "  utility-tests-windows:  ${{ needs.utility-tests-windows.result }}"
          echo "  sanitizer-asan:         ${{ needs.sanitizer-asan.result }}"
          echo "  sanitizer-ubsan:        ${{ needs.sanitizer-ubsan.result }}"
          echo "  real-tensorflow:        ${{ needs.real-tensorflow.result }}"
          
          if [ "${{ needs.header-check.result }}" != "success" ] || \
             [ "${{ needs.linux-gcc.result }}" != "success" ] || \
             [ "${{ needs.linux-clang.result }}" != "success" ] || \
             [ "${{ needs.windows-msvc.result }}" != "success" ] || \
             [ "${{ needs.macos.result }}" != "success" ] || \
             [ "${{ needs.utility-tests.result }}" != "success" ] || \
             [ "${{ needs.utility-tests-windows.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-asan.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-ubsan.result }}" != "success" ] || \
             [ "${{ needs.real-tensorflow.result }}" != "success" ]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi
          
          echo "✓ All CI jobs passed"
